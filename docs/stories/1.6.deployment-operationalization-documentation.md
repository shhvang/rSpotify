# Story 1.6: Deployment Operationalization & Documentation

## Status
Approved

## Story
**As a** bot owner,  
**I want** complete deployment infrastructure with inventory files, templates, and documentation,  
**so that** I can deploy the bot to VPS for both staging (test bot) and production (24/7 production bot) environments.

## Acceptance Criteria
1. Ansible inventory files created for staging and production environments with VPS host configuration
2. Jinja2 template created for environment file (.env) with all required variables
3. Jinja2 template created for Supervisor configuration to manage bot process
4. Jinja2 template created for Nginx configuration for OAuth callback handling
5. Jinja2 template created for log rotation configuration
6. `develop` branch created and configured for staging deployments
7. GitHub Secrets documentation created with complete list of required secrets
8. Initial deployment guide created with step-by-step VPS setup instructions
9. Troubleshooting guide created for common deployment issues
10. Staging deployment tested and verified functional with test bot token
11. Production deployment tested and verified functional with production bot token
12. Rollback capability tested and verified working in under 5 minutes
13. Architecture documentation updated with enhanced GitHub Flow branching strategy
14. All deployment scripts and templates properly documented with inline comments

## Tasks / Subtasks

### CRITICAL: Version Control Setup (MUST BE FIRST)
- [ ] **Task 0: Create Feature Branch** (MANDATORY - Rule #11)
  - [ ] Verify you are on main branch: `git branch --show-current`
  - [ ] Pull latest changes: `git pull origin main`
  - [ ] Create feature branch: `git checkout -b feature/story-1.6-deployment-operationalization`
  - [ ] Verify branch creation: `git branch --show-current` should show feature branch
  - [ ] **REMINDER**: All subsequent commits MUST be on this feature branch, NEVER on main

- [ ] **Task 1: Create Ansible Inventory Files** (AC: 1)
  - [ ] Create `ansible/staging_inventory` file
  - [ ] Configure staging host with IP address, SSH user, and connection parameters
  - [ ] Add staging-specific variables (environment=staging, bot token variable reference)
  - [ ] Create `ansible/production_inventory` file
  - [ ] Configure production host with IP address, SSH user, and connection parameters
  - [ ] Add production-specific variables (environment=production, bot token variable reference)
  - [ ] Document inventory file format and variable usage
  - [ ] Add inventory files to .gitignore if they contain sensitive data (create .inventory.example files)

- [ ] **Task 2: Create Jinja2 Templates** (AC: 2, 3, 4, 5, 14)
  - [ ] Create `ansible/templates/` directory
  - [ ] Create `ansible/templates/env.j2` for environment file
    - [ ] Include all variables from .env.example
    - [ ] Add Ansible variable placeholders for secrets
    - [ ] Add inline comments explaining each variable
  - [ ] Create `ansible/templates/supervisor.conf.j2` for process management
    - [ ] Configure bot process with correct Python path and entry point
    - [ ] Set proper user, working directory, and log paths
    - [ ] Configure auto-restart and error handling
  - [ ] Create `ansible/templates/nginx.conf.j2` for OAuth callback
    - [ ] Configure Flask web callback reverse proxy
    - [ ] Set proper SSL/TLS settings for HTTPS
    - [ ] Add security headers and rate limiting
  - [ ] Create `ansible/templates/logrotate.j2` for log management
    - [ ] Configure daily rotation with 14-day retention
    - [ ] Set compression and permission settings
  - [ ] Add comprehensive inline documentation to all templates
  - [ ] Validate Jinja2 syntax in all templates

- [ ] **Task 3: Branch Strategy Implementation** (AC: 6, 13)
  - [ ] Create `develop` branch from current main: `git checkout -b develop`
  - [ ] Push develop branch to origin: `git push -u origin develop`
  - [ ] Update Architecture Section 7 with enhanced GitHub Flow
    - [ ] Document feature/* → develop → main flow
    - [ ] Add branching diagram if helpful
    - [ ] Update project structure to show ansible/templates/
  - [ ] Update Architecture Section 8 with deployment triggers
    - [ ] Document staging deployment (develop branch)
    - [ ] Document production deployment (main branch)
    - [ ] Add environment strategy section (prod vs staging bot tokens)
  - [ ] Create branch protection rules documentation

- [ ] **Task 4: GitHub Secrets Documentation** (AC: 7)
  - [ ] Create `docs/deployment/github-secrets-setup.md`
  - [ ] Document all required GitHub Secrets:
    - [ ] DEPLOY_SSH_KEY - SSH private key for VPS access
    - [ ] STAGING_HOST - Staging VPS IP/hostname
    - [ ] STAGING_BOT_TOKEN - Test bot token
    - [ ] STAGING_MONGODB_URI - Staging database URI (can be same as prod)
    - [ ] PRODUCTION_HOST - Production VPS IP/hostname
    - [ ] PRODUCTION_BOT_TOKEN - Production bot token (24/7)
    - [ ] PRODUCTION_MONGODB_URI - Production database URI
    - [ ] SPOTIFY_CLIENT_ID - Spotify API client ID
    - [ ] SPOTIFY_CLIENT_SECRET - Spotify API client secret
    - [ ] DUCKDNS_TOKEN - DuckDNS update token
    - [ ] DUCKDNS_DOMAIN - DuckDNS subdomain
    - [ ] OWNER_TELEGRAM_ID - Bot owner's Telegram ID
    - [ ] ENCRYPTION_KEY - Fernet encryption key
  - [ ] Add step-by-step instructions for adding secrets in GitHub UI
  - [ ] Document SSH key generation process

- [ ] **Task 5: Deployment Guides** (AC: 8, 9)
  - [ ] Create `docs/deployment/initial-deployment.md`
    - [ ] VPS preparation checklist (Ubuntu 22.04 recommended)
    - [ ] SSH key setup and VPS access verification
    - [ ] GitHub Secrets configuration steps
    - [ ] Inventory file configuration instructions
    - [ ] First deployment walkthrough
    - [ ] Post-deployment verification checklist
  - [ ] Create `docs/deployment/troubleshooting.md`
    - [ ] Common Ansible errors and solutions
    - [ ] SSH connection issues
    - [ ] Bot not starting issues
    - [ ] Nginx/SSL certificate issues
    - [ ] Database connection problems
    - [ ] Log locations and debugging commands
  - [ ] Create `docs/deployment/rollback-guide.md`
    - [ ] Manual rollback procedure
    - [ ] GitHub Actions rollback workflow usage
    - [ ] Verification steps post-rollback

- [ ] **Task 6: Staging Deployment Testing** (AC: 10)
  - [ ] Configure staging inventory with actual VPS details
  - [ ] Add all required GitHub Secrets for staging
  - [ ] Create test bot via BotFather and obtain token
  - [ ] Push changes to develop branch to trigger staging deployment
  - [ ] Monitor GitHub Actions workflow execution
  - [ ] Verify Ansible playbook completes successfully
  - [ ] SSH to staging VPS and verify bot process running
  - [ ] Test /ping command with test bot
  - [ ] Verify logs are being written correctly
  - [ ] Test DuckDNS update (if applicable to staging)
  - [ ] Document any issues encountered and resolutions

- [ ] **Task 7: Production Deployment Testing** (AC: 11)
  - [ ] Configure production inventory with actual VPS details
  - [ ] Add all required GitHub Secrets for production
  - [ ] Use production bot token (24/7 bot)
  - [ ] Merge feature branch to main (after PR approval)
  - [ ] Monitor production deployment via GitHub Actions
  - [ ] Verify Ansible playbook completes successfully
  - [ ] SSH to production VPS and verify bot process running
  - [ ] Test /ping command with production bot
  - [ ] Verify startup notification sent to owner
  - [ ] Verify HTTPS/SSL certificate for OAuth callback
  - [ ] Test complete OAuth flow on production
  - [ ] Monitor logs for errors over 24-hour period

- [ ] **Task 8: Rollback Testing** (AC: 12)
  - [ ] Document current production deployment commit hash
  - [ ] Trigger manual rollback via GitHub Actions workflow_dispatch
  - [ ] Time the rollback process (must be < 5 minutes)
  - [ ] Verify bot restarts with previous version
  - [ ] Test bot functionality post-rollback
  - [ ] Re-deploy current version to restore production
  - [ ] Document rollback procedure and timing

- [ ] **Task 9: Documentation Updates** (AC: 13, 14)
  - [ ] Update `docs/architecture/7-project-structure-source-control.md`
    - [ ] Add ansible/templates/ and inventory files to structure
    - [ ] Document enhanced GitHub Flow with develop branch
  - [ ] Update `docs/architecture/8-development-deployment-testing.md`
    - [ ] Add environment strategy section
    - [ ] Document deployment triggers and process
  - [ ] Update `docs/prd/6-epic-details.md`
    - [ ] Add Story 1.6 to Epic 1 section
  - [ ] Add dev note to `docs/stories/1.1.project-initialization-core-bot-setup.md`
    - [ ] Reference that Story 1.6 completes deployment configuration
  - [ ] Update main README.md with deployment instructions link

- [ ] **Task 10: Feature Branch Completion** (MANDATORY - Rule #11)
  - [ ] Run all tests and ensure they pass
  - [ ] Commit all changes with descriptive messages
  - [ ] Push feature branch: `git push origin feature/story-1.6-deployment-operationalization`
  - [ ] **DO NOT MERGE** - Create PR and wait for owner approval
  - [ ] Document PR with story completion summary
  - [ ] After owner approval, owner will merge to main

## Dev Notes

### Previous Story Insights
[Source: Story 1.1, 1.2, 1.3 Implementation Experience]
- **Working Directory**: Always work from `/rspotify-bot/` directory, NOT `/rSpotify/`
- **Terminal Safety**: Verify all commands before execution
- **VCS Workflow**: Use feature branches - NEVER commit directly to main
- **Existing Infrastructure**: Ansible playbook and CI/CD pipeline already exist from Story 1.1
- **This Story's Purpose**: Complete the missing configuration files and documentation

### Development Rules & Guidelines - MANDATORY
**CRITICAL REQUIREMENT**: Before starting development, thoroughly read `docs/rules.md`.

**Key Rules for This Story**:
- **Rule #11**: MANDATORY feature branch workflow - create `feature/story-1.6-deployment-operationalization`
- **Rule #9**: Working directory awareness - verify before running commands
- **Rule #10**: Document any new mistakes/solutions in rules.md

### Existing Infrastructure Context
[Source: Story 1.1 & CI/CD Pipeline Analysis]

**Already Implemented:**
- ✅ Ansible playbook (`ansible/setup.yml`) - 205 lines, comprehensive
- ✅ GitHub Actions workflow (`.github/workflows/main.yml`) - 274 lines
- ✅ Deployment jobs for staging and production
- ✅ Rollback workflow
- ✅ Security scanning and testing jobs

**Missing (This Story's Scope):**
- ❌ Ansible inventory files
- ❌ Jinja2 templates (env.j2, supervisor.conf.j2, nginx.conf.j2, logrotate.j2)
- ❌ `develop` branch
- ❌ Deployment documentation

### Ansible Inventory File Format
[Source: Ansible Best Practices]

**Example staging_inventory:**
```ini
[rspotify_servers]
staging-vps ansible_host=YOUR_VPS_IP ansible_user=YOUR_SSH_USER ansible_port=22

[rspotify_servers:vars]
environment=staging
github_repo_url=https://github.com/shhvang/rSpotify.git
app_version=develop
letsencrypt_email=your-email@example.com
domain_name={{ duckdns_domain }}
```

**Example production_inventory:**
```ini
[rspotify_servers]
production-vps ansible_host=YOUR_VPS_IP ansible_user=YOUR_SSH_USER ansible_port=22

[rspotify_servers:vars]
environment=production
github_repo_url=https://github.com/shhvang/rSpotify.git
app_version=main
letsencrypt_email=your-email@example.com
domain_name={{ duckdns_domain }}
```

### Jinja2 Template Examples
[Source: Ansible Templating Documentation]

**env.j2 Structure:**
```jinja2
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN={{ telegram_bot_token }}
OWNER_TELEGRAM_ID={{ owner_telegram_id }}

# Spotify API Configuration
SPOTIFY_CLIENT_ID={{ spotify_client_id }}
SPOTIFY_CLIENT_SECRET={{ spotify_client_secret }}
SPOTIFY_REDIRECT_URI=https://{{ domain_name }}/callback

# Encryption Configuration
ENCRYPTION_KEY={{ encryption_key }}

# Database Configuration
MONGDB_URI={{ mongodb_uri }}
MONGODB_DATABASE=rspotify_bot

# DuckDNS Configuration
DUCKDNS_TOKEN={{ duckdns_token }}
DUCKDNS_DOMAIN={{ duckdns_domain }}

# Environment Configuration
ENVIRONMENT={{ environment }}
DEBUG=false
LOG_LEVEL=INFO
```

**supervisor.conf.j2 Structure:**
```jinja2
[program:rspotify-bot]
command={{ app_dir }}/venv/bin/python {{ app_dir }}/src/rspotify.py
directory={{ app_dir }}/src
user={{ app_user }}
autostart=true
autorestart=true
stderr_logfile={{ app_dir }}/logs/bot_error.log
stdout_logfile={{ app_dir }}/logs/bot_output.log
environment=PATH="{{ app_dir }}/venv/bin"
```

**nginx.conf.j2 Structure:**
```jinja2
server {
    listen 80;
    server_name {{ domain_name }};
    
    location /callback {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### GitHub Flow with Staging (Enhanced)
[Source: Architecture Requirements]

**Branch Strategy:**
```
feature/story-x.y → develop (staging) → main (production)
                       ↓                    ↓
                   Test Bot            Production Bot
                   (Manual testing)    (24/7 Live)
```

**Deployment Triggers:**
- Push to `develop` → Auto-deploy to staging with test bot token
- Push to `main` → Auto-deploy to production with production bot token
- Manual workflow_dispatch → Rollback capability

### Required GitHub Secrets
[Source: CI/CD Pipeline Analysis]

**All Secrets Needed:**
1. `DEPLOY_SSH_KEY` - Private SSH key for VPS access
2. `STAGING_HOST` - Staging VPS IP/hostname
3. `STAGING_BOT_TOKEN` - Test bot token
4. `STAGING_MONGODB_URI` - Database URI for staging
5. `PRODUCTION_HOST` - Production VPS IP/hostname  
6. `PRODUCTION_BOT_TOKEN` - Production bot token (24/7)
7. `PRODUCTION_MONGODB_URI` - Database URI for production
8. `SPOTIFY_CLIENT_ID` - Spotify API credentials
9. `SPOTIFY_CLIENT_SECRET` - Spotify API credentials
10. `DUCKDNS_TOKEN` - DuckDNS update token
11. `DUCKDNS_DOMAIN` - DuckDNS subdomain
12. `OWNER_TELEGRAM_ID` - Bot owner's Telegram ID
13. `ENCRYPTION_KEY` - Fernet encryption key

### Testing

**Testing Standards:**
- No unit tests required for this story (configuration files)
- Integration testing via actual deployments
- Manual verification of bot functionality post-deployment
- Rollback testing required with timing verification (<5 minutes)

**Test Checklist:**
- [ ] Staging deployment successful
- [ ] Production deployment successful  
- [ ] Bot responds to /ping on staging
- [ ] Bot responds to /ping on production
- [ ] Startup notification received on production
- [ ] Rollback completes in <5 minutes
- [ ] Bot functional after rollback

### Project Structure Updates
[Source: Architecture Section 7]

**New Structure After This Story:**
```
rspotify-bot/
├── ansible/
│   ├── setup.yml
│   ├── staging_inventory
│   ├── production_inventory
│   └── templates/
│       ├── env.j2
│       ├── supervisor.conf.j2
│       ├── nginx.conf.j2
│       └── logrotate.j2
├── docs/
│   └── deployment/
│       ├── github-secrets-setup.md
│       ├── initial-deployment.md
│       ├── troubleshooting.md
│       └── rollback-guide.md
├── rspotify_bot/
├── tests/
├── web_callback/
└── ...
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Sept 30, 2025 | 1.0 | Story created from Sprint Change Proposal - Deployment Operationalization | Sarah (PO) |